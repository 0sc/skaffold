apiVersion: v1
kind: Pod
metadata:
  name: kaniko
spec:
  initContainers:
  - name: init-container
    image: ubuntu
    args: ["sh", "-c", "cp -L -r /kaniko/buildcontext/* /kaniko/emptydir && ls /kaniko/emptydir && stat /kaniko/emptydir/Dockerfile"]
    volumeMounts:
      - name: build-context
        mountPath: /kaniko/buildcontext
      - name: empty-dir
        mountPath: /kaniko/emptydir
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    args: ["--dockerfile=Dockerfile",
            "--context=dir:///kaniko/emptydir",
            "--destination=gcr.io/priya-wadhwa/test:test"]
    volumeMounts:
      - name: kaniko-secret
        mountPath: /secret
      - name: build-context
        mountPath: /kaniko/buildcontext
      - name: empty-dir
        mountPath: /kaniko/emptydir
    env:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        value: /secret/kaniko-secret.json
  restartPolicy: Never
  volumes:
    - name: kaniko-secret
      secret:
        secretName: kaniko
    # - name: build-context
    #   persistentVolumeClaim: 
    #     claimName: pv-claim-kaniko
    - name: build-context
      configMap:
        # Provide the name of the ConfigMap containing the files you want
        # to add to the container
        name: kaniko-configmap77a0c64f84c48aeb56093119c709807b
    - name: empty-dir
      emptyDir: {}
